/* web/js/analytics-system.js */
class ITERAAnalyticsSystem{constructor(){this.config={enabled: true,realTimeTracking: true,batchSize: 20,flushInterval: 30000,retentionDays: 90,endpoints:{events: '/api/analytics/events',conversations: '/api/analytics/conversations',performance: '/api/analytics/performance',insights: '/api/analytics/insights'}};this.storage={events: [],conversations: new Map(),performance: [],sessions: new Map(),insights:{daily:{},weekly:{},monthly:{}}};this.metrics={totalConversations: 0,totalMessages: 0,averageResponseTime: 0,urgentConversations: 0,sectorDistribution:{medical: 0,legal: 0,general: 0},sentimentDistribution:{positive: 0,negative: 0,neutral: 0,urgent: 0},conversionRate: 0,satisfactionScore: 0};this.init()}init(){console.log('📊 IT-ERA Analytics System initializing...');this.setupPeriodicFlush();this.setupRealTimeMonitoring();this.integrateWithAI();this.integrateWithChatbot();this.setupCleanup();console.log('✅ IT-ERA Analytics System initialized')}trackEvent(eventType,data={}){if(!this.config.enabled)return;const event={id: this.generateEventId(),type: eventType,timestamp: Date.now(),sessionId: this.getCurrentSessionId(),data:{...data,userAgent: navigator.userAgent,url: window.location.href,referrer: document.referrer}};this.storage.events.push(event);this.updateRealTimeMetrics(event);if(this.isCriticalEvent(eventType)){this.processCriticalEvent(event)}console.log('📈 Event tracked:',eventType,data)}trackConversation(conversationData){const sessionId=conversationData.sessionId||this.getCurrentSessionId();if(!this.storage.conversations.has(sessionId)){this.storage.conversations.set(sessionId,{id: sessionId,startTime: Date.now(),messages: [],analysis:{},outcome: null,satisfaction: null});this.metrics.totalConversations++}const conversation=this.storage.conversations.get(sessionId);if(conversationData.message){conversation.messages.push({timestamp: Date.now(),content: conversationData.message,type: conversationData.messageType||'user',analysis: conversationData.analysis||{}});this.metrics.totalMessages++}if(conversationData.analysis){conversation.analysis={...conversation.analysis,...conversationData.analysis};if(conversationData.analysis.sector){this.metrics.sectorDistribution[conversationData.analysis.sector]++}if(conversationData.analysis.sentiment){this.metrics.sentimentDistribution[conversationData.analysis.sentiment]++}if(conversationData.analysis.urgencyLevel==='critical'){this.metrics.urgentConversations++}}if(conversationData.outcome){conversation.outcome=conversationData.outcome}if(conversationData.satisfaction){conversation.satisfaction=conversationData.satisfaction;this.updateSatisfactionScore(conversationData.satisfaction)}conversation.lastUpdate=Date.now()}trackPerformance(performanceData){const performance={timestamp: Date.now(),sessionId: this.getCurrentSessionId(),...performanceData};this.storage.performance.push(performance);if(performanceData.responseTime){const totalResponseTime=this.metrics.averageResponseTime*(this.metrics.totalMessages-1);this.metrics.averageResponseTime=(totalResponseTime+performanceData.responseTime)/this.metrics.totalMessages}if(this.storage.performance.length>1000){this.storage.performance=this.storage.performance.slice(-500)}}trackSentiment(message,sentiment,confidence){this.trackEvent('sentiment_analysis',{message: message.substring(0,100),sentiment,confidence,messageLength: message.length})}generateInsights(){const now=new Date();const today=now.toISOString().split('T')[0];if(!this.storage.insights.daily[today]){this.storage.insights.daily[today]=this.calculateDailyInsights()}if(now.getDay()===0){const weekKey=this.getWeekKey(now);if(!this.storage.insights.weekly[weekKey]){this.storage.insights.weekly[weekKey]=this.calculateWeeklyInsights()}}if(now.getDate()===1){const monthKey=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;if(!this.storage.insights.monthly[monthKey]){this.storage.insights.monthly[monthKey]=this.calculateMonthlyInsights()}}return{daily: this.storage.insights.daily[today],realTime: this.metrics}}calculateDailyInsights(){const today=new Date().toISOString().split('T')[0];const todayEvents=this.storage.events.filter(event=>new Date(event.timestamp).toISOString().split('T')[0]===today);return{totalEvents: todayEvents.length,conversationsStarted: todayEvents.filter(e=>e.type==='conversation_started').length,emergenciesDetected: todayEvents.filter(e=>e.type==='emergency_triggered').length,averageResponseTime: this.calculateAverageResponseTime(todayEvents),topSectors: this.getTopSectors(todayEvents),sentimentBreakdown: this.getSentimentBreakdown(todayEvents),peakHours: this.getPeakHours(todayEvents)}}calculateWeeklyInsights(){return{conversationTrends: this.getConversationTrends('week'),sectorGrowth: this.getSectorGrowth('week'),performanceMetrics: this.getPerformanceMetrics('week'),userSatisfaction: this.getUserSatisfaction('week')}}calculateMonthlyInsights(){return{businessImpact: this.getBusinessImpact('month'),aiPerformance: this.getAIPerformance('month'),sectorAnalysis: this.getSectorAnalysis('month'),recommendations: this.generateRecommendations('month')}}setupRealTimeMonitoring(){setInterval(()=>{this.checkCriticalMetrics()},5000)}checkCriticalMetrics(){const recentEvents=this.storage.events.filter(event=>Date.now()-event.timestamp<60000);const emergencies=recentEvents.filter(e=>e.type==='emergency_triggered');if(emergencies.length>3){this.alertHighEmergencyVolume(emergencies)}const errors=recentEvents.filter(e=>e.type==='ai_error');if(errors.length>5){this.alertHighErrorRate(errors)}}integrateWithAI(){if(window.ITERA_AI){const originalSendAnalytics=window.ITERA_AI.sendAnalytics;window.ITERA_AI.sendAnalytics=(eventType,data)=>{this.trackEvent(eventType,data);if(originalSendAnalytics){originalSendAnalytics.call(window.ITERA_AI,eventType,data)}}}}integrateWithChatbot(){if(window.ITERASmartChatbot){const originalTrackEvent=window.ITERASmartChatbot.prototype.trackEvent;window.ITERASmartChatbot.prototype.trackEvent=function(eventName,data){window.ITERAAnalytics.trackEvent(eventName,data);if(originalTrackEvent){originalTrackEvent.call(this,eventName,data)}}}}generateEventId(){return 'evt_'+Date.now()+'_'+Math.random().toString(36).substr(2,9)}getCurrentSessionId(){if(!this.currentSessionId){this.currentSessionId='sess_'+Date.now()+'_'+Math.random().toString(36).substr(2,9)}return this.currentSessionId}isCriticalEvent(eventType){return ['emergency_triggered','ai_error','system_failure'].includes(eventType)}processCriticalEvent(event){console.warn('🚨 Critical event detected:',event);this.sendImmediateAlert(event)}sendImmediateAlert(event){console.log('📢 Immediate alert sent for:',event.type)}updateRealTimeMetrics(event){if(event.type==='conversation_started'){this.metrics.totalConversations++}if(event.type==='message_sent'){this.metrics.totalMessages++}}updateSatisfactionScore(satisfaction){const currentScore=this.metrics.satisfactionScore;const totalConversations=this.metrics.totalConversations;this.metrics.satisfactionScore=((currentScore*(totalConversations-1))+satisfaction)/totalConversations}setupPeriodicFlush(){setInterval(()=>{this.flushData()},this.config.flushInterval)}async flushData(){if(this.storage.events.length===0)return;try{await this.sendToServer('events',this.storage.events);const conversationsArray=Array.from(this.storage.conversations.values());if(conversationsArray.length>0){await this.sendToServer('conversations',conversationsArray)}if(this.storage.performance.length>0){await this.sendToServer('performance',this.storage.performance)}this.storage.events=[];this.storage.performance=[];console.log('📤 Analytics data flushed to server')}catch(error){console.error('❌ Failed to flush analytics data:',error)}}async sendToServer(endpoint,data){const url=this.config.endpoints[endpoint];if(!url)return;const response=await fetch(url,{method: 'POST',headers:{'Content-Type': 'application/json'},body: JSON.stringify({data,timestamp: Date.now()})});if(!response.ok){throw new Error(`Analytics server error: ${response.status}`)}}setupCleanup(){setInterval(()=>{this.cleanupOldData()},3600000)}cleanupOldData(){const cutoffTime=Date.now()-(this.config.retentionDays*24*60*60*1000);this.storage.events=this.storage.events.filter(event=>event.timestamp>cutoffTime);for(const [sessionId,conversation] of this.storage.conversations.entries()){if(conversation.lastUpdate<cutoffTime){this.storage.conversations.delete(sessionId)}}console.log('🧹 Old analytics data cleaned up')}getMetrics(){return{...this.metrics}}getInsights(){return this.generateInsights()}exportData(format='json'){const data={metrics: this.metrics,events: this.storage.events,conversations: Array.from(this.storage.conversations.values()),performance: this.storage.performance,insights: this.storage.insights};if(format==='csv'){return this.convertToCSV(data)}return JSON.stringify(data,null,2)}}window.ITERAAnalytics=new ITERAAnalyticsSystem();window.ITERAAnalytics.api={track:(event,data)=>window.ITERAAnalytics.trackEvent(event,data),getMetrics:()=>window.ITERAAnalytics.getMetrics(),getInsights:()=>window.ITERAAnalytics.getInsights(),export:(format)=>window.ITERAAnalytics.exportData(format)};if(typeof module!=='undefined'&&module.exports){module.exports=ITERAAnalyticsSystem}console.log('📊 IT-ERA Advanced Analytics System loaded');

/* web/js/sector-personalization.js */
class ITERASectorPersonalization{constructor(){this.sectorProfiles={medical:{name: 'Settore Sanitario',compliance: ['GDPR Sanitario','Privacy Pazienti','Sicurezza Dati Clinici'],terminology:{data: 'dati clinici',security: 'sicurezza sanitaria',backup: 'backup cartelle cliniche',compliance: 'compliance sanitaria'},services: [ 'Gestione cartelle cliniche digitali','Backup sicuro dati pazienti','Telemedicina e consulti online','Sistemi di prenotazione','Compliance GDPR sanitario' ],urgencyKeywords: [ 'paziente','emergenza sanitaria','dati clinici','cartelle','sistema ospedaliero','prenotazioni','referto','diagnosi' ],responseTemplates:{greeting: '🏥 Benvenuto nel supporto IT specializzato per il settore sanitario!',urgency: '🚨**EMERGENZA SANITARIA IT**-Chiama immediatamente: 039 888 2041',compliance: '✅ IT-ERA garantisce piena compliance GDPR sanitario per tutti i servizi medici.',services: 'I nostri servizi specializzati per studi medici e ospedali includono:'},riskFactors:{dataLoss: 10,systemDown: 9,securityBreach: 10,complianceIssue: 8}},legal:{name: 'Settore Legale',compliance: ['GDPR Legale','Riservatezza Documenti','Sicurezza Archivi'],terminology:{data: 'documenti legali',security: 'riservatezza',backup: 'archiviazione sicura',compliance: 'compliance legale'},services: [ 'Archiviazione sicura documenti legali','Backup e disaster recovery','Firma digitale e PEC','Sistemi di gestione pratiche','Compliance GDPR legale' ],urgencyKeywords: [ 'causa','scadenza','tribunale','documenti legali','contratto','pratica','udienza','sentenza','archivio','riservatezza' ],responseTemplates:{greeting: '⚖️ Benvenuto nel supporto IT specializzato per studi legali!',urgency: '🚨**EMERGENZA LEGALE IT**-Chiama immediatamente: 039 888 2041',compliance: '✅ IT-ERA assicura massima riservatezza e compliance GDPR per studi legali.',services: 'I nostri servizi specializzati per studi legali includono:'},riskFactors:{dataLoss: 9,systemDown: 8,securityBreach: 10,complianceIssue: 9}},general:{name: 'Settore Generale',compliance: ['GDPR Generale','Sicurezza Aziendale','Privacy Dipendenti'],terminology:{data: 'dati aziendali',security: 'sicurezza informatica',backup: 'backup aziendale',compliance: 'compliance GDPR'},services: [ 'Assistenza IT completa 24/7','Cybersecurity aziendale','Cloud storage e backup','VoIP e centralino cloud','Consulenza IT strategica' ],urgencyKeywords: [ 'business','produzione','vendite','ufficio','dipendenti','server','rete','email','sistema aziendale' ],responseTemplates:{greeting: '💼 Benvenuto nel supporto IT per aziende lombarde!',urgency: '🚨**EMERGENZA IT AZIENDALE**-Chiama immediatamente: 039 888 2041',compliance: '✅ IT-ERA garantisce compliance GDPR per tutte le aziende.',services: 'I nostri servizi IT aziendali includono:'},riskFactors:{dataLoss: 7,systemDown: 8,securityBreach: 8,complianceIssue: 6}}};this.init()}init(){console.log('🎯 IT-ERA Sector Personalization System initialized');if(window.ITERA_AI){window.ITERA_AI.sectorPersonalization=this}}detectSector(message,context={}){const text=message.toLowerCase();const sectorScores={};for(const [sectorKey,sectorData] of Object.entries(this.sectorProfiles)){let score=0;sectorData.urgencyKeywords.forEach(keyword=>{if(text.includes(keyword.toLowerCase())){score+=5}});sectorData.compliance.forEach(keyword=>{if(text.includes(keyword.toLowerCase())){score+=3}});sectorData.services.forEach(service=>{const serviceWords=service.toLowerCase().split(' ');serviceWords.forEach(word=>{if(word.length>3&&text.includes(word)){score+=2}})});if(context.previousSector===sectorKey){score+=2}if(context.userAgent&&context.userAgent.includes('Mobile')){if(sectorKey==='medical')score+=1}sectorScores[sectorKey]=score}const sortedSectors=Object.entries(sectorScores).sort(([,a],[,b])=>b-a);const bestMatch=sortedSectors[0];const confidence=bestMatch[1]/Math.max(1,Math.max(...Object.values(sectorScores)));return{sector: bestMatch[1]>0 ? bestMatch[0] : 'general',confidence: confidence,scores: sectorScores,alternatives: sortedSectors.slice(1,3).map(([sector,score])=>({sector,score,confidence: score/Math.max(1,bestMatch[1])}))}}personalizeResponse(baseResponse,sector,analysis={}){const sectorProfile=this.sectorProfiles[sector]||this.sectorProfiles.general;let personalizedResponse=baseResponse;if(analysis.isFirstMessage){personalizedResponse=`${sectorProfile.responseTemplates.greeting}\n\n${personalizedResponse}`}if(analysis.urgencyLevel==='critical'){personalizedResponse=`${sectorProfile.responseTemplates.urgency}\n\n${personalizedResponse}`}for(const [generic,specific] of Object.entries(sectorProfile.terminology)){const regex=new RegExp(`\\b${generic}\\b`,'gi');personalizedResponse=personalizedResponse.replace(regex,specific)}if(!personalizedResponse.includes('GDPR')&&!personalizedResponse.includes('compliance')){personalizedResponse+=`\n\n${sectorProfile.responseTemplates.compliance}`}if(analysis.intent==='service_inquiry'||analysis.recommendedService){personalizedResponse+=`\n\n${sectorProfile.responseTemplates.services}`;sectorProfile.services.slice(0,3).forEach((service,index)=>{personalizedResponse+=`\n${index+1}. ${service}`})}return personalizedResponse}calculateRiskScore(message,sector,urgencyAnalysis){const sectorProfile=this.sectorProfiles[sector]||this.sectorProfiles.general;const text=message.toLowerCase();let riskScore=urgencyAnalysis.score||0;if(text.includes('perso')||text.includes('cancellato')){riskScore+=sectorProfile.riskFactors.dataLoss}if(text.includes('down')||text.includes('non funziona')){riskScore+=sectorProfile.riskFactors.systemDown}if(text.includes('hacker')||text.includes('virus')||text.includes('sicurezza')){riskScore+=sectorProfile.riskFactors.securityBreach}if(text.includes('gdpr')||text.includes('privacy')||text.includes('compliance')){riskScore+=sectorProfile.riskFactors.complianceIssue}return{score: riskScore,level: riskScore>=15 ? 'critical' : riskScore>=10 ? 'high' : riskScore>=5 ? 'medium' : 'low',factors: this.identifyRiskFactors(text,sectorProfile)}}identifyRiskFactors(text,sectorProfile){const factors=[];if(text.includes('perso')||text.includes('cancellato')){factors.push('data_loss')}if(text.includes('down')||text.includes('non funziona')){factors.push('system_down')}if(text.includes('hacker')||text.includes('virus')){factors.push('security_breach')}if(text.includes('gdpr')||text.includes('privacy')){factors.push('compliance_issue')}return factors}getSectorKnowledge(sector){return this.sectorProfiles[sector]||this.sectorProfiles.general}generateRecommendations(sector,analysis){const sectorProfile=this.sectorProfiles[sector]||this.sectorProfiles.general;const recommendations=[];if(analysis.urgencyLevel==='critical'){recommendations.push({type: 'immediate_action',title: 'Contatto Immediato',description: 'Chiama subito 039 888 2041 per assistenza prioritaria',priority: 1})}if(analysis.recommendedService){const relevantServices=sectorProfile.services.filter(service=>service.toLowerCase().includes(analysis.recommendedService.toLowerCase()));relevantServices.forEach((service,index)=>{recommendations.push({type: 'service_recommendation',title: service,description: `Servizio specializzato per ${sectorProfile.name}`,priority: index+2})})}return recommendations.sort((a,b)=>a.priority-b.priority)}}window.ITERASectorPersonalization=new ITERASectorPersonalization();if(typeof module!=='undefined'&&module.exports){module.exports=ITERASectorPersonalization}console.log('🎯 IT-ERA Sector Personalization System loaded');

