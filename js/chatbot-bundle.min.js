/* web/js/ai-config.js */
class ITERAIConfig{constructor(){this.openaiApiKey=this.getSecureApiKey();this.openaiApiUrl='https: this.performanceConfig={maxRetries: 3,retryDelay: 1000,timeout: 15000,rateLimitDelay: 2000,cacheEnabled: true,cacheTTL: 300000};this.responseCache=new Map();this.requestQueue=[];this.isProcessingQueue=false;this.companyInfo={name: 'IT-ERA',phone: '039 888 2041',email: 'info@it-era.it',address: 'Viale Risorgimento 32,Vimercate MB',services: [ 'Assistenza IT 24/7','Cybersecurity e Sicurezza Informatica','Cloud Storage e Backup','VoIP e Centralino Cloud','Soluzioni per Studi Medici','Soluzioni per Studi Legali' ],responseTime: '15 minuti garantiti',coverage: 'Lombardia',businessHours:{weekdays: '08:00-18:00',emergency: '24/7',timezone: 'Europe/Rome'}};this.urgencyConfig={keywords:{critical: ['emergenza','down','bloccato','hackerato','ransomware','virus','non funziona'],high: ['urgente','subito','immediato','problema grave','server'],medium: ['problema','aiuto','supporto','lento'],low: ['informazione','preventivo','consulenza']},timeFactors:{outOfHours: 1.5,weekend: 1.3,businessHours: 1.0},sectorMultipliers:{medical: 1.8,legal: 1.5,general: 1.0}};this.sectorKnowledge={medical:{compliance: ['GDPR sanitario','Privacy pazienti','Sicurezza dati clinici'],services: ['Gestione cartelle cliniche','Backup sicuro','Telemedicina'],urgencyKeywords: ['paziente','emergenza sanitaria','dati clinici']},legal:{compliance: ['GDPR legale','Riservatezza','Sicurezza documenti'],services: ['Archiviazione sicura','Backup legale','Firma digitale'],urgencyKeywords: ['causa','scadenza','tribunale','documenti legali']},general:{compliance: ['GDPR generale','Sicurezza aziendale'],services: ['Assistenza generale','Manutenzione','Consulenza'],urgencyKeywords: ['business','produzione','vendite']}};this.analyticsConfig={enabled: true,trackConversations: true,trackSentiment: true,trackPerformance: true,sessionTimeout: 1800000,metricsEndpoint: '/api/analytics/chatbot',batchSize: 10,flushInterval: 30000};this.conversationMetrics={sessions: new Map(),responses: [],errors: [],performance: []};this.chatbotPersonality=` Sei l'assistente virtuale avanzato di IT-ERA,l'azienda leader in Lombardia per servizi IT aziendali. INFORMAZIONI AZIENDA:-Nome: IT-ERA-Telefono: 039 888 2041(SEMPRE da fornire per emergenze)-Email: info@it-era.it-Indirizzo: Viale Risorgimento 32,Vimercate MB-Copertura: Tutta la Lombardia-Tempo di risposta: 15 minuti garantiti per emergenze-Orari: 24/7 per emergenze,08:00-18:00 per consulenze SERVIZI PRINCIPALI: 1. üö® Assistenza IT 24/7-Supporto tecnico immediato 2. üõ°Ô∏è Cybersecurity-Protezione avanzata WatchGuard 3. ‚òÅÔ∏è Cloud&Backup-Migrazione e disaster recovery 4. üìû VoIP Wildix-Centralino cloud professionale 5. üè• IT Studi Medici-GDPR sanitario compliance 6. ‚öñÔ∏è IT Studi Legali-Sicurezza dati sensibili PERSONALIT√Ä AVANZATA:-Professionale ma empatico-Tecnico ma accessibile-Proattivo nel rilevare urgenze-Personalizza risposte per settore-Monitora sentiment e adatta tono-Focus su soluzioni immediate e concrete REGOLE CRITICHE: 1. EMERGENZE: Fornisci SEMPRE il numero 039 888 2041 con massima priorit√† 2. SETTORI: Adatta linguaggio e soluzioni per medico/legale/generale 3. URGENZA: Rileva automaticamente situazioni critiche e escalation 4. COMPLIANCE: Menziona GDPR per settori sensibili 5. LOCALIT√Ä: Includi sempre riferimenti a citt√† lombarde 6. GARANZIA: Enfatizza sempre i 15 minuti garantiti per emergenze 7. SENTIMENT: Adatta tono basandoti sull'emozione dell'utente RISPOSTE OTTIMIZZATE:-Brevi ma complete(max 4-5 frasi)-Call-to-action specifico per settore-Numero telefono prominente per urgenze-Personalizzazione intelligente per contesto `}getSecureApiKey(){if(typeof process!=='undefined'&&process.env.OPENAI_API_KEY){return process.env.OPENAI_API_KEY}return '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'}async callOpenAI(messages,options={}){const startTime=performance.now();const cacheKey=this.generateCacheKey(messages,options);if(this.performanceConfig.cacheEnabled&&this.responseCache.has(cacheKey)){const cached=this.responseCache.get(cacheKey);if(Date.now()-cached.timestamp<this.performanceConfig.cacheTTL){this.trackPerformance('cache_hit',performance.now()-startTime);return cached.response}this.responseCache.delete(cacheKey)}const defaultOptions={model: 'gpt-4',max_tokens: 300,temperature: 0.7,top_p: 1,frequency_penalty: 0,presence_penalty: 0};const requestOptions={...defaultOptions,...options};return this.queueRequest(async()=>{try{const controller=new AbortController();const timeoutId=setTimeout(()=>controller.abort(),this.performanceConfig.timeout);const response=await fetch(this.openaiApiUrl,{method: 'POST',headers:{'Content-Type': 'application/json','Authorization': `Bearer ${this.openaiApiKey}`},body: JSON.stringify({...requestOptions,messages: [{role: 'system',content: this.getSectorPersonality(options.sector||'general')},...messages ]}),signal: controller.signal});clearTimeout(timeoutId);if(!response.ok){throw new Error(`OpenAI API error: ${response.status}-${response.statusText}`)}const data=await response.json();const result=data.choices[0].message.content;if(this.performanceConfig.cacheEnabled){this.responseCache.set(cacheKey,{response: result,timestamp: Date.now()})}this.trackPerformance('api_success',performance.now()-startTime);return result}catch(error){this.trackPerformance('api_error',performance.now()-startTime,error);console.error('OpenAI API Error:',error);if(error.name==='AbortError'){return this.getFallbackResponse('timeout')}else if(error.message.includes('429')){return this.getFallbackResponse('rate_limit')}else{return this.getFallbackResponse('general')}}})}generateCacheKey(messages,options){const content=messages.map(m=>m.content).join('|');const opts=JSON.stringify(options);return btoa(content+opts).substring(0,32)}async queueRequest(requestFn){return new Promise((resolve,reject)=>{this.requestQueue.push({requestFn,resolve,reject});this.processQueue()})}async processQueue(){if(this.isProcessingQueue||this.requestQueue.length===0)return;this.isProcessingQueue=true;while(this.requestQueue.length>0){const{requestFn,resolve,reject}=this.requestQueue.shift();try{const result=await requestFn();resolve(result)}catch(error){reject(error)}if(this.requestQueue.length>0){await new Promise(resolve=>setTimeout(resolve,this.performanceConfig.rateLimitDelay))}}this.isProcessingQueue=false}trackPerformance(type,duration,error=null){const metric={type,duration,timestamp: Date.now(),error: error ? error.message : null};this.conversationMetrics.performance.push(metric);if(this.conversationMetrics.performance.length>100){this.conversationMetrics.performance.shift()}if(this.analyticsConfig.enabled){this.sendAnalytics('performance',metric)}}getSectorPersonality(sector){const basePersonality=this.chatbotPersonality;const sectorInfo=this.sectorKnowledge[sector]||this.sectorKnowledge.general;return `${basePersonality}SETTORE SPECIFICO: ${sector.toUpperCase()}COMPLIANCE RICHIESTA: ${sectorInfo.compliance.join(',')}SERVIZI SPECIALIZZATI: ${sectorInfo.services.join(',')}PAROLE CHIAVE URGENZA: ${sectorInfo.urgencyKeywords.join(',')}`}getFallbackResponse(errorType='general'){const fallbacksByType={timeout: [ `‚è±Ô∏è Connessione lenta rilevata!Per assistenza immediata chiama il 039 888 2041-risposta garantita in 15 minuti!`,`üö® EMERGENZA IT? Non aspettare!Chiama subito 039 888 2041-IT-ERA risponde in 15 minuti!` ],rate_limit: [ `üîÑ Sistema temporaneamente occupato. Per assistenza immediata chiama il 039 888 2041!`,`‚ö° Troppo traffico!Per supporto istantaneo: 039 888 2041-IT-ERA sempre disponibile!` ],general: [ `Ciao!Sono l'assistente IT-ERA. Per assistenza immediata chiama il 039 888 2041-risposta garantita in 15 minuti!üö®`,`Problemi IT? Contatta subito IT-ERA al 039 888 2041. Siamo specializzati in assistenza 24/7 per aziende lombarde!üíª`,`Emergenza informatica? Chiama ora il 039 888 2041. IT-ERA risolve i tuoi problemi IT in 15 minuti!‚ö°`,`Hai bisogno di supporto IT? Contatta IT-ERA al 039 888 2041. Assistenza professionale per tutta la Lombardia!üõ°Ô∏è` ]};const fallbacks=fallbacksByType[errorType]||fallbacksByType.general;return fallbacks[Math.floor(Math.random()*fallbacks.length)]}detectUrgency(message){const text=message.toLowerCase();let urgencyScore=0;for(const [level,keywords] of Object.entries(this.urgencyConfig.keywords)){const matches=keywords.filter(keyword=>text.includes(keyword)).length;switch(level){case 'critical': urgencyScore+=matches*10;break;case 'high': urgencyScore+=matches*7;break;case 'medium': urgencyScore+=matches*4;break;case 'low': urgencyScore+=matches*1;break}}const hour=new Date().getHours();const isWeekend=[0,6].includes(new Date().getDay());if(hour<8||hour>18){urgencyScore*=this.urgencyConfig.timeFactors.outOfHours}if(isWeekend){urgencyScore*=this.urgencyConfig.timeFactors.weekend}return{isUrgent: urgencyScore>=7,score: urgencyScore,level: urgencyScore>=15 ? 'critical' : urgencyScore>=10 ? 'high' : urgencyScore>=5 ? 'medium' : 'low'}}detectSector(message){const text=message.toLowerCase();const sectorScores={};for(const [sector,data] of Object.entries(this.sectorKnowledge)){let score=0;data.compliance.forEach(keyword=>{if(text.includes(keyword.toLowerCase()))score+=3});data.services.forEach(keyword=>{if(text.includes(keyword.toLowerCase()))score+=2});data.urgencyKeywords.forEach(keyword=>{if(text.includes(keyword.toLowerCase()))score+=4});sectorScores[sector]=score}const bestSector=Object.entries(sectorScores).sort(([,a],[,b])=>b-a)[0];return{sector: bestSector[1]>0 ? bestSector[0] : 'general',confidence: bestSector[1],scores: sectorScores}}getServiceRecommendation(message){const text=message.toLowerCase();const serviceKeywords={'assistenza': ['supporto','aiuto','problema','non funziona','guasto'],'cybersecurity': ['sicurezza','virus','malware','hacker','protezione','firewall'],'cloud': ['backup','cloud','archiviazione','migrazione','disaster recovery'],'voip': ['telefono','centralino','chiamate','voip','comunicazione'],'medici': ['medico','sanitario','gdpr sanitario','cartelle cliniche'],'legali': ['legale','avvocato','studio legale','documenti legali']};const scores={};for(const [service,keywords] of Object.entries(serviceKeywords)){scores[service]=keywords.filter(keyword=>text.includes(keyword)).length}const bestService=Object.entries(scores).sort(([,a],[,b])=>b-a)[0];return{service: bestService[1]>0 ? bestService[0] : 'assistenza',confidence: bestService[1],allScores: scores}}detectSentiment(message){const text=message.toLowerCase();const sentimentKeywords={positive: ['grazie','perfetto','ottimo','bene','soddisfatto','risolto'],negative: ['problema','male','sbagliato','insoddisfatto','arrabbiato','frustrato'],urgent: ['urgente','subito','emergenza','critico','bloccato'],neutral: ['informazione','preventivo','consulenza','domanda']};const scores={};for(const [sentiment,keywords] of Object.entries(sentimentKeywords)){scores[sentiment]=keywords.filter(keyword=>text.includes(keyword)).length}const dominantSentiment=Object.entries(scores).sort(([,a],[,b])=>b-a)[0];return{sentiment: dominantSentiment[1]>0 ? dominantSentiment[0] : 'neutral',confidence: dominantSentiment[1],scores: scores}}sendAnalytics(eventType,data){if(!this.analyticsConfig.enabled)return;const analyticsData={timestamp: Date.now(),eventType,data,sessionId: this.getSessionId(),userAgent: navigator.userAgent,url: window.location.href};this.conversationMetrics.responses.push(analyticsData);this.batchSendAnalytics()}batchSendAnalytics(){if(this.conversationMetrics.responses.length>=this.analyticsConfig.batchSize){this.flushAnalytics()}}async flushAnalytics(){if(this.conversationMetrics.responses.length===0)return;const batch=[...this.conversationMetrics.responses];this.conversationMetrics.responses=[];try{await fetch(this.analyticsConfig.metricsEndpoint,{method: 'POST',headers:{'Content-Type': 'application/json'},body: JSON.stringify({metrics: batch})})}catch(error){console.warn('Analytics send failed:',error);this.conversationMetrics.responses.unshift(...batch)}}getSessionId(){if(!this.sessionId){this.sessionId='itera_'+Date.now()+'_'+Math.random().toString(36).substr(2,9)}return this.sessionId}enableAuggieIntegration(auggieInstance){this.auggieEnabled=true;this.auggieIntegration=auggieInstance;console.log('ü§ñ Auggie integration enabled');this.originalCallOpenAI=this.callOpenAI.bind(this);this.callOpenAI=this.callWithAuggieFallback.bind(this)}async callWithAuggieFallback(messages,options={}){if(this.auggieEnabled&&this.auggieIntegration){try{const auggieResponse=await this.auggieIntegration.processMessage(messages[messages.length-1].content,{sector: options.sector,urgency: options.urgency,context: this.getConversationContext()});if(auggieResponse&&auggieResponse.confidence>0.7){this.sendAnalytics('auggie_success',{confidence: auggieResponse.confidence});return auggieResponse.response}}catch(error){console.warn('Auggie fallback to OpenAI:',error);this.sendAnalytics('auggie_fallback',{error: error.message})}}return this.originalCallOpenAI(messages,options)}getConversationContext(){return{sessionId: this.getSessionId(),messageCount: this.conversationMetrics.responses.length,averageResponseTime: this.getAverageResponseTime(),userSentiment: this.getCurrentSentiment()}}getAverageResponseTime(){const responseTimes=this.conversationMetrics.performance .filter(m=>m.type==='api_success').map(m=>m.duration);return responseTimes.length>0 ? responseTimes.reduce((a,b)=>a+b,0)/responseTimes.length : 0}getCurrentSentiment(){const recentResponses=this.conversationMetrics.responses.slice(-5);const sentiments=recentResponses .filter(r=>r.data&&r.data.sentiment).map(r=>r.data.sentiment);return sentiments.length>0 ? sentiments[sentiments.length-1] : 'neutral'}cleanup(){const now=Date.now();for(const [key,value] of this.responseCache.entries()){if(now-value.timestamp>this.performanceConfig.cacheTTL){this.responseCache.delete(key)}}this.flushAnalytics()}}window.ITERA_AI=new ITERAIConfig();setInterval(()=>{window.ITERA_AI.cleanup()},300000);setInterval(()=>{window.ITERA_AI.flushAnalytics()},window.ITERA_AI.analyticsConfig.flushInterval);console.log('üß† IT-ERA Enhanced AI Config loaded');console.log('‚úÖ Features: Advanced urgency detection,sector personalization,analytics,Auggie integration ready');if(typeof module!=='undefined'&&module.exports){module.exports=ITERAIConfig}

/* web/js/smart-chatbot.js */
class ITERASmartChatbot{constructor(){this.isInitialized=false;this.conversationHistory=[];this.userSession=this.generateSessionId();this.isTyping=false;if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',()=>this.init())}else{this.init()}}generateSessionId(){return 'itera_'+Date.now()+'_'+Math.random().toString(36).substr(2,9)}init(){if(this.isInitialized)return;console.log('ü§ñ Inizializzazione IT-ERA Smart Chatbot...');this.waitForTawkTo(()=>{this.enhanceTawkTo();this.setupCustomHandlers();this.isInitialized=true;console.log('‚úÖ IT-ERA Smart Chatbot inizializzato con successo')})}waitForTawkTo(callback,maxAttempts=50){let attempts=0;const checkTawk=()=>{attempts++;if(window.Tawk_API&&window.Tawk_API.onLoad){callback()}else if(attempts<maxAttempts){setTimeout(checkTawk,200)}else{console.warn('‚ö†Ô∏è Tawk.to non trovato,attivazione chatbot standalone');this.createStandaloneChatbot()}};checkTawk()}enhanceTawkTo(){window.Tawk_API.onLoad=()=>{console.log('üöÄ Tawk.to caricato,attivazione AI...');window.Tawk_API.setAttributes({'name': 'Visitatore IT-ERA','email': '','company': '','sector': 'general'});this.sendWelcomeMessage()};window.Tawk_API.onChatMessageVisitor=(message)=>{this.processUserMessage(message.text)};window.Tawk_API.onChatStarted=()=>{console.log('üí¨ Chat iniziata con IT-ERA Smart Bot');this.conversationHistory=[]}}async sendWelcomeMessage(){const hour=new Date().getHours();let greeting='Buongiorno';if(hour>=12&&hour<18)greeting='Buon pomeriggio';else if(hour>=18)greeting='Buonasera';const welcomeMessage=`${greeting}!üëã Sono l'assistente virtuale di IT-ERA. üö®**EMERGENZA IT?**Chiama subito:**039 888 2041**‚ö° Risposta garantita in 15 minuti!Come posso aiutarti oggi? Scrivi il tuo problema e ti fornir√≤ supporto immediato!üíª`;if(window.Tawk_API&&window.Tawk_API.addEvent){window.Tawk_API.addEvent({event: 'welcome_message',metadata:{message: welcomeMessage,timestamp: new Date().toISOString()}})}}async processUserMessage(message){if(this.isTyping)return;console.log('üìù Messaggio utente:',message);this.conversationHistory.push({role: 'user',content: message,timestamp: new Date().toISOString()});const analysis=this.analyzeMessage(message);this.showTypingIndicator();try{const aiResponse=await this.generateAIResponse(message,analysis);await this.sendBotResponse(aiResponse,analysis)}catch(error){console.error('‚ùå Errore AI Response:',error);await this.sendFallbackResponse(analysis)}finally{this.hideTypingIndicator()}}analyzeMessage(message){const urgencyAnalysis=window.ITERA_AI.detectUrgency(message);const sectorAnalysis=window.ITERA_AI.detectSector(message);const serviceAnalysis=window.ITERA_AI.getServiceRecommendation(message);const sentimentAnalysis=window.ITERA_AI.detectSentiment(message);const analysis={isUrgent: urgencyAnalysis.isUrgent||urgencyAnalysis.score>=7,urgencyScore: urgencyAnalysis.score,urgencyLevel: urgencyAnalysis.level,sector: sectorAnalysis.sector||sectorAnalysis,sectorConfidence: sectorAnalysis.confidence||0,recommendedService: serviceAnalysis.service||serviceAnalysis,serviceConfidence: serviceAnalysis.confidence||0,sentiment: sentimentAnalysis.sentiment||this.detectSentiment(message),sentimentConfidence: sentimentAnalysis.confidence||0,intent: this.detectIntent(message),timestamp: Date.now(),messageLength: message.length,hasEmergencyKeywords: this.hasEmergencyKeywords(message)};if(window.ITERA_AI.analyticsConfig.enabled){window.ITERA_AI.sendAnalytics('message_analysis',analysis)}console.log('üîç Enhanced message analysis:',analysis);return analysis}hasEmergencyKeywords(message){const emergencyKeywords=[ 'emergenza','emergency','urgente','subito','immediato','bloccato','down','non funziona','hackerato','virus','ransomware','attacco','sicurezza compromessa','dati persi','server down','rete down','email down','sistema compromesso' ];return emergencyKeywords.some(keyword=>message.toLowerCase().includes(keyword))}handleUrgentMessage(analysis){if(analysis.urgencyLevel==='critical'||analysis.urgencyScore>=15){this.triggerEmergencyProtocol(analysis);return true}else if(analysis.isUrgent||analysis.urgencyScore>=7){this.triggerPriorityHandling(analysis);return true}return false}triggerEmergencyProtocol(analysis){console.log('üö® EMERGENCY PROTOCOL TRIGGERED:',analysis);this.showEmergencyContact();if(window.ITERA_AI.analyticsConfig.enabled){window.ITERA_AI.sendAnalytics('emergency_triggered',{urgencyScore: analysis.urgencyScore,sector: analysis.sector,timestamp: Date.now()})}this.escalateToHuman(analysis)}triggerPriorityHandling(analysis){console.log('‚ö° PRIORITY HANDLING ACTIVATED:',analysis);this.priorityMode=true;if(window.ITERA_AI.analyticsConfig.enabled){window.ITERA_AI.sendAnalytics('priority_triggered',{urgencyScore: analysis.urgencyScore,sector: analysis.sector})}}showEmergencyContact(){const emergencyWidget=document.createElement('div');emergencyWidget.className='emergency-contact-widget';emergencyWidget.innerHTML=`<div class="emergency-alert"><h3>üö® EMERGENZA IT RILEVATA</h3><p><strong>Chiama IMMEDIATAMENTE:</strong></p><a href="tel:0398882041" class="emergency-phone">039 888 2041</a><p class="emergency-guarantee">‚ö° Risposta garantita in 15 minuti!</p></div>`;const chatContainer=document.querySelector('.chat-messages')||document.body;chatContainer.insertBefore(emergencyWidget,chatContainer.firstChild);setTimeout(()=>{if(emergencyWidget.parentNode){emergencyWidget.parentNode.removeChild(emergencyWidget)}},30000)}escalateToHuman(analysis){console.log('üë§ Escalating to human operator:',analysis);this.addSystemMessage(` üîÑ**Escalation in corso...**La tua richiesta √® stata classificata come emergenza e inoltrata al nostro team tecnico.**Contatta immediatamente: 039 888 2041**`)}addSystemMessage(message){if(window.Tawk_API&&window.Tawk_API.addEvent){window.Tawk_API.addEvent({event: 'system_message',metadata:{message: message,timestamp: new Date().toISOString(),type: 'escalation'}})}}detectSentiment(message){const positiveWords=['grazie','perfetto','ottimo','bene','soddisfatto'];const negativeWords=['problema','errore','non funziona','bloccato','frustrato'];const positive=positiveWords.some(word=>message.toLowerCase().includes(word));const negative=negativeWords.some(word=>message.toLowerCase().includes(word));if(positive&&!negative)return 'positive';if(negative&&!positive)return 'negative';return 'neutral'}detectIntent(message){const intents={'get_info': ['info','informazioni','cosa','come','quando'],'request_support': ['aiuto','supporto','problema','assistenza'],'get_quote': ['preventivo','prezzo','costo','quanto'],'emergency': ['emergenza','urgente','subito','immediato'],'contact': ['contatto','telefono','email','chiamare']};for(const [intent,keywords] of Object.entries(intents)){if(keywords.some(keyword=>message.toLowerCase().includes(keyword))){return intent}}return 'general'}async generateAIResponse(message,analysis){const startTime=performance.now();const isHandledUrgent=this.handleUrgentMessage(analysis);const enhancedContext=this.buildEnhancedContext(message,analysis);const messages=[ ...this.conversationHistory.slice(-5),{role: 'user',content: enhancedContext}];const aiOptions=this.getAIOptions(analysis);try{const response=await window.ITERA_AI.callOpenAI(messages,aiOptions);const enhancedResponse=this.enhanceResponse(response,analysis);this.conversationHistory.push({role: 'assistant',content: enhancedResponse,timestamp: new Date().toISOString(),analysis: analysis,responseTime: performance.now()-startTime});if(window.ITERA_AI.analyticsConfig.enabled){window.ITERA_AI.sendAnalytics('ai_response_generated',{responseTime: performance.now()-startTime,urgencyLevel: analysis.urgencyLevel,sector: analysis.sector,responseLength: enhancedResponse.length})}return enhancedResponse}catch(error){console.error('‚ùå AI Response generation failed:',error);return this.getEnhancedFallback(analysis,error)}}buildEnhancedContext(message,analysis){return `${message}ANALISI AVANZATA:-Urgenza: ${analysis.urgencyLevel}(Score: ${analysis.urgencyScore})-Settore: ${analysis.sector}(Confidence: ${analysis.sectorConfidence})-Servizio: ${analysis.recommendedService}(Confidence: ${analysis.serviceConfidence})-Sentiment: ${analysis.sentiment}(Confidence: ${analysis.sentimentConfidence})-Intent: ${analysis.intent}-Emergenza: ${analysis.hasEmergencyKeywords ? 'S√å' : 'NO'}-Lunghezza messaggio: ${analysis.messageLength}ISTRUZIONI SPECIFICHE: ${this.getContextualInstructions(analysis)}`}getContextualInstructions(analysis){let instructions=[];if(analysis.urgencyLevel==='critical'){instructions.push('-PRIORIT√Ä MASSIMA: Fornisci numero emergenza 039 888 2041 IMMEDIATAMENTE');instructions.push('-Usa tono urgente ma professionale');instructions.push('-Menziona garanzia 15 minuti')}if(analysis.sector==='medical'){instructions.push('-Menziona compliance GDPR sanitario');instructions.push('-Enfatizza sicurezza dati pazienti');instructions.push('-Usa terminologia medica appropriata')}else if(analysis.sector==='legal'){instructions.push('-Menziona compliance GDPR legale');instructions.push('-Enfatizza riservatezza documenti');instructions.push('-Usa terminologia legale appropriata')}if(analysis.sentiment==='negative'){instructions.push('-Usa tono empatico e rassicurante');instructions.push('-Offri soluzioni immediate')}return instructions.join('\n')}getAIOptions(analysis){const baseOptions={max_tokens: 250,temperature: 0.7,sector: analysis.sector};if(analysis.urgencyLevel==='critical'){baseOptions.max_tokens=150;baseOptions.temperature=0.5}else if(analysis.urgencyLevel==='high'){baseOptions.max_tokens=200;baseOptions.temperature=0.6}if(analysis.sentiment==='negative'){baseOptions.temperature=0.8}return baseOptions}enhanceResponse(response,analysis){let enhanced=response;if(analysis.urgencyLevel==='critical'&&!enhanced.includes('039 888 2041')){enhanced=`üö®**EMERGENZA**: Chiama subito 039 888 2041!\n\n${enhanced}`}if(analysis.sector==='medical'&&!enhanced.includes('GDPR')){enhanced+='\n\nüè•*IT-ERA garantisce compliance GDPR sanitario.*'}else if(analysis.sector==='legal'&&!enhanced.includes('GDPR')){enhanced+='\n\n‚öñÔ∏è*IT-ERA assicura compliance GDPR legale.*'}return enhanced}getEnhancedFallback(analysis,error){if(analysis.urgencyLevel==='critical'){return `üö®**EMERGENZA IT RILEVATA**Sistema temporaneamente non disponibile,ma la tua emergenza √® prioritaria!**CHIAMA IMMEDIATAMENTE: 039 888 2041**‚ö° Risposta garantita in 15 minuti!IT-ERA √® sempre pronto per le emergenze informatiche!`}return window.ITERA_AI.getFallbackResponse(error.name==='AbortError' ? 'timeout' : 'general')}async sendBotResponse(response,analysis){let formattedResponse=response;if(analysis.isUrgent){formattedResponse=`üö®**EMERGENZA RILEVATA**üö®\n\n${response}\n\nüìû**CHIAMA SUBITO: 039 888 2041**`}if(analysis.sector==='medical'){formattedResponse+='\n\nüè• Specializzati in GDPR sanitario e sistemi medici'}else if(analysis.sector==='legal'){formattedResponse+='\n\n‚öñÔ∏è Esperti in sicurezza dati per studi legali'}if(window.Tawk_API&&window.Tawk_API.addEvent){window.Tawk_API.addEvent({event: 'ai_response',metadata:{message: formattedResponse,analysis: analysis,timestamp: new Date().toISOString()}})}console.log('ü§ñ Risposta AI inviata:',formattedResponse)}async sendFallbackResponse(analysis){let fallback=window.ITERA_AI.getFallbackResponse();if(analysis.isUrgent){fallback=`üö®**EMERGENZA IT RILEVATA**üö®\n\nChiama IMMEDIATAMENTE:**039 888 2041**\nRisposta garantita in 15 minuti!\n\nIT-ERA √® sempre pronto per le tue emergenze informatiche!‚ö°`}await this.sendBotResponse(fallback,analysis)}showTypingIndicator(){this.isTyping=true;const typingIndicator=document.createElement('div');typingIndicator.className='typing-indicator';typingIndicator.id='typing-indicator';typingIndicator.innerHTML=`<div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;const messagesContainer=this.getMessagesContainer();if(messagesContainer){messagesContainer.appendChild(typingIndicator);this.scrollToBottom()}if(window.Tawk_API&&window.Tawk_API.addEvent){window.Tawk_API.addEvent({event: 'typing_indicator',metadata:{status: 'started',timestamp: new Date().toISOString()}})}console.log('üí¨ Enhanced typing indicator shown')}hideTypingIndicator(){this.isTyping=false;const typingIndicator=document.getElementById('typing-indicator');if(typingIndicator){typingIndicator.remove()}if(window.Tawk_API&&window.Tawk_API.addEvent){window.Tawk_API.addEvent({event: 'typing_indicator',metadata:{status: 'stopped',timestamp: new Date().toISOString()}})}console.log('üí¨ Enhanced typing indicator hidden')}getMessagesContainer(){return document.querySelector('.chat-messages')||document.querySelector('.chatbot-messages')||document.querySelector('#chat-messages')||document.querySelector('.tawk-messages')}scrollToBottom(){const container=this.getMessagesContainer();if(container){container.scrollTop=container.scrollHeight}}createStandaloneChatbot(){console.log('üîß Creazione chatbot standalone...');const chatWidget=document.createElement('div');chatWidget.id='itera-standalone-chat';chatWidget.innerHTML=`<div class="chat-widget"><div class="chat-header"><h4>üí¨ IT-ERA Assistant</h4><span class="chat-status">üü¢ Online</span></div><div class="chat-messages" id="chat-messages"></div><div class="chat-input"><input type="text" id="chat-input" placeholder="Scrivi il tuo problema IT..."><button id="chat-send">üì§</button></div></div>`;const styles=`<style>#itera-standalone-chat{position: fixed;bottom: 20px;right: 20px;width: 350px;height: 500px;background: white;border-radius: 10px;box-shadow: 0 5px 20px rgba(0,0,0,0.2);z-index: 9999;font-family: Inter,sans-serif}.chat-widget{height: 100%;display: flex;flex-direction: column}.chat-header{background: #0056cc;color: white;padding: 15px;border-radius: 10px 10px 0 0}.chat-messages{flex: 1;padding: 15px;overflow-y: auto}.chat-input{display: flex;padding: 15px;border-top: 1px solid #eee}#chat-input{flex: 1;padding: 10px;border: 1px solid #ddd;border-radius: 5px}#chat-send{margin-left: 10px;padding: 10px 15px;background: #0056cc;color: white;border: none;border-radius: 5px;cursor: pointer}</style>`;document.head.insertAdjacentHTML('beforeend',styles);document.body.appendChild(chatWidget);this.setupStandaloneChatHandlers()}setupStandaloneChatHandlers(){const input=document.getElementById('chat-input');const sendBtn=document.getElementById('chat-send');const messages=document.getElementById('chat-messages');const sendMessage=async()=>{const message=input.value.trim();if(!message)return;messages.innerHTML+=`<div class="user-message"><strong>Tu:</strong>${message}</div>`;input.value='';await this.processUserMessage(message)};sendBtn.addEventListener('click',sendMessage);input.addEventListener('keypress',(e)=>{if(e.key==='Enter')sendMessage()})}setupCustomHandlers(){document.addEventListener('click',(e)=>{if(e.target.matches('[href^="tel:"]')){this.trackEvent('phone_click',{number: e.target.href.replace('tel:',''),source: 'chatbot_recommendation'})}})}trackEvent(eventName,data){if(window.gtag){window.gtag('event',eventName,{event_category: 'chatbot',event_label: 'ai_interaction',custom_parameters: data})}console.log('üìä Event tracked:',eventName,data)}}window.ITERASmartChatbot=new ITERASmartChatbot();if(typeof module!=='undefined'&&module.exports){module.exports=ITERASmartChatbot}

/* web/js/itera-ai-enhanced.js */
class ITERAEnhancedAI{constructor(){this.version='2.0.0';this.initialized=false;this.components={aiConfig: null,chatbot: null,analytics: null,sectorPersonalization: null,auggieIntegration: null};this.config={enableAuggie: true,enableAnalytics: true,enableSectorPersonalization: true,enableEnhancedUX: true,fallbackChain: ['auggie','openai','static'],debug: false};this.init()}async init(){console.log('üöÄ IT-ERA Enhanced AI System initializing...');try{if(document.readyState==='loading'){await new Promise(resolve=>{document.addEventListener('DOMContentLoaded',resolve)})}await this.initializeComponents();this.setupIntegrations();this.setupGlobalAPI();this.setupMonitoring();this.initialized=true;console.log('‚úÖ IT-ERA Enhanced AI System initialized successfully');this.trackEvent('system_initialized',{version: this.version,components: Object.keys(this.components),timestamp: Date.now()})}catch(error){console.error('‚ùå IT-ERA Enhanced AI System initialization failed:',error);this.handleInitializationError(error)}}async initializeComponents(){if(window.ITERA_AI){this.components.aiConfig=window.ITERA_AI;console.log('‚úÖ AI Config component loaded')}if(window.ITERAAnalytics){this.components.analytics=window.ITERAAnalytics;console.log('‚úÖ Analytics component loaded')}if(window.ITERASectorPersonalization){this.components.sectorPersonalization=window.ITERASectorPersonalization;console.log('‚úÖ Sector Personalization component loaded')}if(window.ITERASmartChatbot){this.components.chatbot=window.ITERASmartChatbot;console.log('‚úÖ Smart Chatbot component loaded')}if(window.ITERAuggieIntegration&&this.config.enableAuggie){this.components.auggieIntegration=window.ITERAuggieIntegration;console.log('‚úÖ Auggie Integration component loaded')}}setupIntegrations(){if(this.components.analytics){this.integrateAnalytics()}if(this.components.sectorPersonalization){this.integrateSectorPersonalization()}if(this.components.auggieIntegration){this.integrateAuggie()}this.setupErrorHandling()}integrateAnalytics(){const analytics=this.components.analytics;if(this.components.aiConfig){const originalCallOpenAI=this.components.aiConfig.callOpenAI;this.components.aiConfig.callOpenAI=async function(messages,options={}){const startTime=performance.now();try{const result=await originalCallOpenAI.call(this,messages,options);analytics.trackPerformance({type: 'ai_response',responseTime: performance.now()-startTime,success: true,model: options.model||'gpt-4',tokens: result.length});return result}catch(error){analytics.trackPerformance({type: 'ai_response',responseTime: performance.now()-startTime,success: false,error: error.message});throw error}}}console.log('üîó Analytics integration completed')}integrateSectorPersonalization(){const personalization=this.components.sectorPersonalization;if(this.components.aiConfig){const originalCallOpenAI=this.components.aiConfig.callOpenAI;this.components.aiConfig.callOpenAI=async function(messages,options={}){if(!options.sector&&messages.length>0){const lastMessage=messages[messages.length-1].content;const sectorAnalysis=personalization.detectSector(lastMessage);options.sector=sectorAnalysis.sector;options.sectorConfidence=sectorAnalysis.confidence}const result=await originalCallOpenAI.call(this,messages,options);if(options.sector){return personalization.personalizeResponse(result,options.sector,{urgencyLevel: options.urgencyLevel,intent: options.intent})}return result}}console.log('üéØ Sector Personalization integration completed')}integrateAuggie(){const auggie=this.components.auggieIntegration;if(this.components.aiConfig&&auggie.auggieAvailable){this.components.aiConfig.enableAuggieIntegration(auggie);console.log('ü§ñ Auggie integration enabled')}else{console.log('‚ö†Ô∏è Auggie not available,using OpenAI fallback')}}setupErrorHandling(){window.addEventListener('error',(event)=>{if(event.error&&event.error.message.includes('ITERA')){this.handleError(event.error)}});window.addEventListener('unhandledrejection',(event)=>{if(event.reason&&event.reason.message&&event.reason.message.includes('ITERA')){this.handleError(event.reason)}})}setupGlobalAPI(){window.ITERA_AI_ENHANCED={version: this.version,initialized:()=>this.initialized,track:(event,data)=>this.trackEvent(event,data),getMetrics:()=>this.components.analytics?.getMetrics()||{},getInsights:()=>this.components.analytics?.getInsights()||{},chat:(message,options={})=>this.processMessage(message,options),detectUrgency:(message)=>this.components.aiConfig?.detectUrgency(message),detectSector:(message)=>this.components.sectorPersonalization?.detectSector(message),getStatus:()=>this.getSystemStatus(),enableAuggie:()=>this.enableAuggie(),disableAuggie:()=>this.disableAuggie(),debug:(enabled)=>{this.config.debug=enabled},getComponents:()=>this.components,getConfig:()=>this.config};console.log('üåê Global API setup completed')}setupMonitoring(){setInterval(()=>{this.performHealthCheck()},60000);setInterval(()=>{this.monitorPerformance()},30000)}async processMessage(message,options={}){if(!this.initialized){throw new Error('IT-ERA Enhanced AI System not initialized')}const startTime=performance.now();try{const analysis=await this.analyzeMessage(message,options);const response=await this.generateResponse(message,analysis,options);this.trackEvent('message_processed',{messageLength: message.length,responseTime: performance.now()-startTime,analysis: analysis,success: true});return{response,analysis,responseTime: performance.now()-startTime}}catch(error){this.handleError(error);throw error}}async analyzeMessage(message,options={}){const analysis={};if(this.components.aiConfig){analysis.urgency=this.components.aiConfig.detectUrgency(message)}if(this.components.sectorPersonalization){analysis.sector=this.components.sectorPersonalization.detectSector(message,options)}if(this.components.aiConfig){analysis.sentiment=this.components.aiConfig.detectSentiment(message)}if(this.components.aiConfig){analysis.service=this.components.aiConfig.getServiceRecommendation(message)}return analysis}async generateResponse(message,analysis,options={}){const messages=[{role: 'user',content: message}];const aiOptions={...options,sector: analysis.sector?.sector,urgencyLevel: analysis.urgency?.level,sentiment: analysis.sentiment?.sentiment};return await this.components.aiConfig.callOpenAI(messages,aiOptions)}trackEvent(eventType,data={}){if(this.components.analytics){this.components.analytics.trackEvent(eventType,data)}if(this.config.debug){console.log('üìä Event tracked:',eventType,data)}}getSystemStatus(){return{version: this.version,initialized: this.initialized,components: Object.keys(this.components).reduce((status,key)=>{status[key]=!!this.components[key];return status},{}),config: this.config,health: this.getHealthStatus()}}getHealthStatus(){return{aiConfig:!!this.components.aiConfig,chatbot:!!this.components.chatbot,analytics:!!this.components.analytics,sectorPersonalization:!!this.components.sectorPersonalization,auggieIntegration:!!this.components.auggieIntegration,overall: this.initialized}}performHealthCheck(){const health=this.getHealthStatus();if(!health.overall){console.warn('‚ö†Ô∏è IT-ERA Enhanced AI System health check failed');this.trackEvent('health_check_failed',health)}}monitorPerformance(){const performance={memory: this.getMemoryUsage(),responseTime: this.getAverageResponseTime(),errorRate: this.getErrorRate()};this.trackEvent('performance_monitor',performance)}getMemoryUsage(){if(performance.memory){return{used: performance.memory.usedJSHeapSize,total: performance.memory.totalJSHeapSize,limit: performance.memory.jsHeapSizeLimit}}return null}getAverageResponseTime(){return this.components.analytics?.getMetrics()?.averageResponseTime||0}getErrorRate(){const metrics=this.components.analytics?.getMetrics();if(metrics&&metrics.totalMessages>0){return(metrics.errors||0)/metrics.totalMessages}return 0}enableAuggie(){this.config.enableAuggie=true;if(this.components.auggieIntegration){this.components.auggieIntegration.enableAuggie()}}disableAuggie(){this.config.enableAuggie=false;if(this.components.auggieIntegration){this.components.auggieIntegration.disableAuggie()}}handleError(error){console.error('‚ùå IT-ERA Enhanced AI Error:',error);this.trackEvent('system_error',{message: error.message,stack: error.stack,timestamp: Date.now()})}handleInitializationError(error){console.error('‚ùå Initialization failed,falling back to basic mode');if(window.ITERA_AI){this.components.aiConfig=window.ITERA_AI}this.initialized=true}}window.ITERAEnhancedAI=new ITERAEnhancedAI();if(typeof module!=='undefined'&&module.exports){module.exports=ITERAEnhancedAI}console.log('üß† IT-ERA Enhanced AI System loaded');

