class ITERASmartChatbot{constructor(){this.isInitialized=false;this.conversationHistory=[];this.userSession=this.generateSessionId();this.isTyping=false;if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',()=>this.init())}else{this.init()}}generateSessionId(){return 'itera_'+Date.now()+'_'+Math.random().toString(36).substr(2,9)}init(){if(this.isInitialized)return;console.log('ü§ñ Inizializzazione IT-ERA Smart Chatbot...');this.waitForTawkTo(()=>{this.enhanceTawkTo();this.setupCustomHandlers();this.isInitialized=true;console.log('‚úÖ IT-ERA Smart Chatbot inizializzato con successo')})}waitForTawkTo(callback,maxAttempts=50){let attempts=0;const checkTawk=()=>{attempts++;if(window.Tawk_API&&window.Tawk_API.onLoad){callback()}else if(attempts<maxAttempts){setTimeout(checkTawk,200)}else{console.warn('‚ö†Ô∏è Tawk.to non trovato,attivazione chatbot standalone');this.createStandaloneChatbot()}};checkTawk()}enhanceTawkTo(){window.Tawk_API.onLoad=()=>{console.log('üöÄ Tawk.to caricato,attivazione AI...');window.Tawk_API.setAttributes({'name': 'Visitatore IT-ERA','email': '','company': '','sector': 'general'});this.sendWelcomeMessage()};window.Tawk_API.onChatMessageVisitor=(message)=>{this.processUserMessage(message.text)};window.Tawk_API.onChatStarted=()=>{console.log('üí¨ Chat iniziata con IT-ERA Smart Bot');this.conversationHistory=[]}}async sendWelcomeMessage(){const hour=new Date().getHours();let greeting='Buongiorno';if(hour>=12&&hour<18)greeting='Buon pomeriggio';else if(hour>=18)greeting='Buonasera';const welcomeMessage=`${greeting}!üëã Sono l'assistente virtuale di IT-ERA. üö®**EMERGENZA IT?**Chiama subito:**039 888 2041**‚ö° Risposta garantita in 15 minuti!Come posso aiutarti oggi? Scrivi il tuo problema e ti fornir√≤ supporto immediato!üíª`;if(window.Tawk_API&&window.Tawk_API.addEvent){window.Tawk_API.addEvent({event: 'welcome_message',metadata:{message: welcomeMessage,timestamp: new Date().toISOString()}})}}async processUserMessage(message){if(this.isTyping)return;console.log('üìù Messaggio utente:',message);this.conversationHistory.push({role: 'user',content: message,timestamp: new Date().toISOString()});const analysis=this.analyzeMessage(message);this.showTypingIndicator();try{const aiResponse=await this.generateAIResponse(message,analysis);await this.sendBotResponse(aiResponse,analysis)}catch(error){console.error('‚ùå Errore AI Response:',error);await this.sendFallbackResponse(analysis)}finally{this.hideTypingIndicator()}}analyzeMessage(message){const urgencyAnalysis=window.ITERA_AI.detectUrgency(message);const sectorAnalysis=window.ITERA_AI.detectSector(message);const serviceAnalysis=window.ITERA_AI.getServiceRecommendation(message);const sentimentAnalysis=window.ITERA_AI.detectSentiment(message);const analysis={isUrgent: urgencyAnalysis.isUrgent||urgencyAnalysis.score>=7,urgencyScore: urgencyAnalysis.score,urgencyLevel: urgencyAnalysis.level,sector: sectorAnalysis.sector||sectorAnalysis,sectorConfidence: sectorAnalysis.confidence||0,recommendedService: serviceAnalysis.service||serviceAnalysis,serviceConfidence: serviceAnalysis.confidence||0,sentiment: sentimentAnalysis.sentiment||this.detectSentiment(message),sentimentConfidence: sentimentAnalysis.confidence||0,intent: this.detectIntent(message),timestamp: Date.now(),messageLength: message.length,hasEmergencyKeywords: this.hasEmergencyKeywords(message)};if(window.ITERA_AI.analyticsConfig.enabled){window.ITERA_AI.sendAnalytics('message_analysis',analysis)}console.log('üîç Enhanced message analysis:',analysis);return analysis}hasEmergencyKeywords(message){const emergencyKeywords=[ 'emergenza','emergency','urgente','subito','immediato','bloccato','down','non funziona','hackerato','virus','ransomware','attacco','sicurezza compromessa','dati persi','server down','rete down','email down','sistema compromesso' ];return emergencyKeywords.some(keyword=>message.toLowerCase().includes(keyword))}handleUrgentMessage(analysis){if(analysis.urgencyLevel==='critical'||analysis.urgencyScore>=15){this.triggerEmergencyProtocol(analysis);return true}else if(analysis.isUrgent||analysis.urgencyScore>=7){this.triggerPriorityHandling(analysis);return true}return false}triggerEmergencyProtocol(analysis){console.log('üö® EMERGENCY PROTOCOL TRIGGERED:',analysis);this.showEmergencyContact();if(window.ITERA_AI.analyticsConfig.enabled){window.ITERA_AI.sendAnalytics('emergency_triggered',{urgencyScore: analysis.urgencyScore,sector: analysis.sector,timestamp: Date.now()})}this.escalateToHuman(analysis)}triggerPriorityHandling(analysis){console.log('‚ö° PRIORITY HANDLING ACTIVATED:',analysis);this.priorityMode=true;if(window.ITERA_AI.analyticsConfig.enabled){window.ITERA_AI.sendAnalytics('priority_triggered',{urgencyScore: analysis.urgencyScore,sector: analysis.sector})}}showEmergencyContact(){const emergencyWidget=document.createElement('div');emergencyWidget.className='emergency-contact-widget';emergencyWidget.innerHTML=`<div class="emergency-alert"><h3>üö® EMERGENZA IT RILEVATA</h3><p><strong>Chiama IMMEDIATAMENTE:</strong></p><a href="tel:0398882041" class="emergency-phone">039 888 2041</a><p class="emergency-guarantee">‚ö° Risposta garantita in 15 minuti!</p></div>`;const chatContainer=document.querySelector('.chat-messages')||document.body;chatContainer.insertBefore(emergencyWidget,chatContainer.firstChild);setTimeout(()=>{if(emergencyWidget.parentNode){emergencyWidget.parentNode.removeChild(emergencyWidget)}},30000)}escalateToHuman(analysis){console.log('üë§ Escalating to human operator:',analysis);this.addSystemMessage(` üîÑ**Escalation in corso...**La tua richiesta √® stata classificata come emergenza e inoltrata al nostro team tecnico.**Contatta immediatamente: 039 888 2041**`)}addSystemMessage(message){if(window.Tawk_API&&window.Tawk_API.addEvent){window.Tawk_API.addEvent({event: 'system_message',metadata:{message: message,timestamp: new Date().toISOString(),type: 'escalation'}})}}detectSentiment(message){const positiveWords=['grazie','perfetto','ottimo','bene','soddisfatto'];const negativeWords=['problema','errore','non funziona','bloccato','frustrato'];const positive=positiveWords.some(word=>message.toLowerCase().includes(word));const negative=negativeWords.some(word=>message.toLowerCase().includes(word));if(positive&&!negative)return 'positive';if(negative&&!positive)return 'negative';return 'neutral'}detectIntent(message){const intents={'get_info': ['info','informazioni','cosa','come','quando'],'request_support': ['aiuto','supporto','problema','assistenza'],'get_quote': ['preventivo','prezzo','costo','quanto'],'emergency': ['emergenza','urgente','subito','immediato'],'contact': ['contatto','telefono','email','chiamare']};for(const [intent,keywords] of Object.entries(intents)){if(keywords.some(keyword=>message.toLowerCase().includes(keyword))){return intent}}return 'general'}async generateAIResponse(message,analysis){const startTime=performance.now();const isHandledUrgent=this.handleUrgentMessage(analysis);const enhancedContext=this.buildEnhancedContext(message,analysis);const messages=[ ...this.conversationHistory.slice(-5),{role: 'user',content: enhancedContext}];const aiOptions=this.getAIOptions(analysis);try{const response=await window.ITERA_AI.callOpenAI(messages,aiOptions);const enhancedResponse=this.enhanceResponse(response,analysis);this.conversationHistory.push({role: 'assistant',content: enhancedResponse,timestamp: new Date().toISOString(),analysis: analysis,responseTime: performance.now()-startTime});if(window.ITERA_AI.analyticsConfig.enabled){window.ITERA_AI.sendAnalytics('ai_response_generated',{responseTime: performance.now()-startTime,urgencyLevel: analysis.urgencyLevel,sector: analysis.sector,responseLength: enhancedResponse.length})}return enhancedResponse}catch(error){console.error('‚ùå AI Response generation failed:',error);return this.getEnhancedFallback(analysis,error)}}buildEnhancedContext(message,analysis){return `${message}ANALISI AVANZATA:-Urgenza: ${analysis.urgencyLevel}(Score: ${analysis.urgencyScore})-Settore: ${analysis.sector}(Confidence: ${analysis.sectorConfidence})-Servizio: ${analysis.recommendedService}(Confidence: ${analysis.serviceConfidence})-Sentiment: ${analysis.sentiment}(Confidence: ${analysis.sentimentConfidence})-Intent: ${analysis.intent}-Emergenza: ${analysis.hasEmergencyKeywords ? 'S√å' : 'NO'}-Lunghezza messaggio: ${analysis.messageLength}ISTRUZIONI SPECIFICHE: ${this.getContextualInstructions(analysis)}`}getContextualInstructions(analysis){let instructions=[];if(analysis.urgencyLevel==='critical'){instructions.push('-PRIORIT√Ä MASSIMA: Fornisci numero emergenza 039 888 2041 IMMEDIATAMENTE');instructions.push('-Usa tono urgente ma professionale');instructions.push('-Menziona garanzia 15 minuti')}if(analysis.sector==='medical'){instructions.push('-Menziona compliance GDPR sanitario');instructions.push('-Enfatizza sicurezza dati pazienti');instructions.push('-Usa terminologia medica appropriata')}else if(analysis.sector==='legal'){instructions.push('-Menziona compliance GDPR legale');instructions.push('-Enfatizza riservatezza documenti');instructions.push('-Usa terminologia legale appropriata')}if(analysis.sentiment==='negative'){instructions.push('-Usa tono empatico e rassicurante');instructions.push('-Offri soluzioni immediate')}return instructions.join('\n')}getAIOptions(analysis){const baseOptions={max_tokens: 250,temperature: 0.7,sector: analysis.sector};if(analysis.urgencyLevel==='critical'){baseOptions.max_tokens=150;baseOptions.temperature=0.5}else if(analysis.urgencyLevel==='high'){baseOptions.max_tokens=200;baseOptions.temperature=0.6}if(analysis.sentiment==='negative'){baseOptions.temperature=0.8}return baseOptions}enhanceResponse(response,analysis){let enhanced=response;if(analysis.urgencyLevel==='critical'&&!enhanced.includes('039 888 2041')){enhanced=`üö®**EMERGENZA**: Chiama subito 039 888 2041!\n\n${enhanced}`}if(analysis.sector==='medical'&&!enhanced.includes('GDPR')){enhanced+='\n\nüè•*IT-ERA garantisce compliance GDPR sanitario.*'}else if(analysis.sector==='legal'&&!enhanced.includes('GDPR')){enhanced+='\n\n‚öñÔ∏è*IT-ERA assicura compliance GDPR legale.*'}return enhanced}getEnhancedFallback(analysis,error){if(analysis.urgencyLevel==='critical'){return `üö®**EMERGENZA IT RILEVATA**Sistema temporaneamente non disponibile,ma la tua emergenza √® prioritaria!**CHIAMA IMMEDIATAMENTE: 039 888 2041**‚ö° Risposta garantita in 15 minuti!IT-ERA √® sempre pronto per le emergenze informatiche!`}return window.ITERA_AI.getFallbackResponse(error.name==='AbortError' ? 'timeout' : 'general')}async sendBotResponse(response,analysis){let formattedResponse=response;if(analysis.isUrgent){formattedResponse=`üö®**EMERGENZA RILEVATA**üö®\n\n${response}\n\nüìû**CHIAMA SUBITO: 039 888 2041**`}if(analysis.sector==='medical'){formattedResponse+='\n\nüè• Specializzati in GDPR sanitario e sistemi medici'}else if(analysis.sector==='legal'){formattedResponse+='\n\n‚öñÔ∏è Esperti in sicurezza dati per studi legali'}if(window.Tawk_API&&window.Tawk_API.addEvent){window.Tawk_API.addEvent({event: 'ai_response',metadata:{message: formattedResponse,analysis: analysis,timestamp: new Date().toISOString()}})}console.log('ü§ñ Risposta AI inviata:',formattedResponse)}async sendFallbackResponse(analysis){let fallback=window.ITERA_AI.getFallbackResponse();if(analysis.isUrgent){fallback=`üö®**EMERGENZA IT RILEVATA**üö®\n\nChiama IMMEDIATAMENTE:**039 888 2041**\nRisposta garantita in 15 minuti!\n\nIT-ERA √® sempre pronto per le tue emergenze informatiche!‚ö°`}await this.sendBotResponse(fallback,analysis)}showTypingIndicator(){this.isTyping=true;const typingIndicator=document.createElement('div');typingIndicator.className='typing-indicator';typingIndicator.id='typing-indicator';typingIndicator.innerHTML=`<div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;const messagesContainer=this.getMessagesContainer();if(messagesContainer){messagesContainer.appendChild(typingIndicator);this.scrollToBottom()}if(window.Tawk_API&&window.Tawk_API.addEvent){window.Tawk_API.addEvent({event: 'typing_indicator',metadata:{status: 'started',timestamp: new Date().toISOString()}})}console.log('üí¨ Enhanced typing indicator shown')}hideTypingIndicator(){this.isTyping=false;const typingIndicator=document.getElementById('typing-indicator');if(typingIndicator){typingIndicator.remove()}if(window.Tawk_API&&window.Tawk_API.addEvent){window.Tawk_API.addEvent({event: 'typing_indicator',metadata:{status: 'stopped',timestamp: new Date().toISOString()}})}console.log('üí¨ Enhanced typing indicator hidden')}getMessagesContainer(){return document.querySelector('.chat-messages')||document.querySelector('.chatbot-messages')||document.querySelector('#chat-messages')||document.querySelector('.tawk-messages')}scrollToBottom(){const container=this.getMessagesContainer();if(container){container.scrollTop=container.scrollHeight}}createStandaloneChatbot(){console.log('üîß Creazione chatbot standalone...');const chatWidget=document.createElement('div');chatWidget.id='itera-standalone-chat';chatWidget.innerHTML=`<div class="chat-widget"><div class="chat-header"><h4>üí¨ IT-ERA Assistant</h4><span class="chat-status">üü¢ Online</span></div><div class="chat-messages" id="chat-messages"></div><div class="chat-input"><input type="text" id="chat-input" placeholder="Scrivi il tuo problema IT..."><button id="chat-send">üì§</button></div></div>`;const styles=`<style>#itera-standalone-chat{position: fixed;bottom: 20px;right: 20px;width: 350px;height: 500px;background: white;border-radius: 10px;box-shadow: 0 5px 20px rgba(0,0,0,0.2);z-index: 9999;font-family: Inter,sans-serif}.chat-widget{height: 100%;display: flex;flex-direction: column}.chat-header{background: #0056cc;color: white;padding: 15px;border-radius: 10px 10px 0 0}.chat-messages{flex: 1;padding: 15px;overflow-y: auto}.chat-input{display: flex;padding: 15px;border-top: 1px solid #eee}#chat-input{flex: 1;padding: 10px;border: 1px solid #ddd;border-radius: 5px}#chat-send{margin-left: 10px;padding: 10px 15px;background: #0056cc;color: white;border: none;border-radius: 5px;cursor: pointer}</style>`;document.head.insertAdjacentHTML('beforeend',styles);document.body.appendChild(chatWidget);this.setupStandaloneChatHandlers()}setupStandaloneChatHandlers(){const input=document.getElementById('chat-input');const sendBtn=document.getElementById('chat-send');const messages=document.getElementById('chat-messages');const sendMessage=async()=>{const message=input.value.trim();if(!message)return;messages.innerHTML+=`<div class="user-message"><strong>Tu:</strong>${message}</div>`;input.value='';await this.processUserMessage(message)};sendBtn.addEventListener('click',sendMessage);input.addEventListener('keypress',(e)=>{if(e.key==='Enter')sendMessage()})}setupCustomHandlers(){document.addEventListener('click',(e)=>{if(e.target.matches('[href^="tel:"]')){this.trackEvent('phone_click',{number: e.target.href.replace('tel:',''),source: 'chatbot_recommendation'})}})}trackEvent(eventName,data){if(window.gtag){window.gtag('event',eventName,{event_category: 'chatbot',event_label: 'ai_interaction',custom_parameters: data})}console.log('üìä Event tracked:',eventName,data)}}window.ITERASmartChatbot=new ITERASmartChatbot();if(typeof module!=='undefined'&&module.exports){module.exports=ITERASmartChatbot}