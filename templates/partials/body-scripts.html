<!-- IT-ERA Body Scripts - GA4 + Chatbot Integration -->

<!-- Google Analytics 4 + GTM -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-T5VWN9EH21"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-T5VWN9EH21', {
    anonymize_ip: true,
    cookie_flags: 'SameSite=None;Secure'
  });
</script>

<!-- Google Tag Manager (noscript) -->
<noscript>
  <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KPF3JZT"
          height="0" width="0" style="display:none;visibility:hidden"></iframe>
</noscript>

<!-- IT-ERA Chatbot Widget -->
<script>
  // Load chatbot only in production
  if (typeof window !== 'undefined' && window.location.hostname === 'it-era.it') {
    const chatScript = document.createElement('script');
    chatScript.src = '/api/src/chatbot/widget/chat-widget.js';
    chatScript.async = true;
    chatScript.onload = function() {
      if (typeof window.initChatWidget === 'function') {
        window.initChatWidget({
          apiEndpoint: '/api/src/chatbot/api/chatbot-worker.js',
          position: 'bottom-right',
          theme: 'it-era',
          greeting: 'Ciao! Sono l\'assistente IT-ERA. Come posso aiutarti?'
        });
      }
    };
    document.body.appendChild(chatScript);
  }
</script>

<!-- Performance and Security -->
<script>
  // Preconnect to external resources
  if ('requestIdleCallback' in window) {
    requestIdleCallback(() => {
      const preconnects = [
        'https://www.googletagmanager.com',
        'https://www.google-analytics.com',
        'https://fonts.googleapis.com',
        'https://fonts.gstatic.com'
      ];
      
      preconnects.forEach(url => {
        const link = document.createElement('link');
        link.rel = 'preconnect';
        link.href = url;
        link.crossOrigin = 'anonymous';
        document.head.appendChild(link);
      });
    });
  }
</script>