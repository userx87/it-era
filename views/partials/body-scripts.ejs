<!-- Body Scripts - JavaScript, Tracking, etc. -->

<%
// Use analytics configuration passed from server
// const analyticsConfig is passed from the route handler
%>

<!-- Main JavaScript -->
<script src="/js/main.js"></script>

<!-- Analytics Tracking -->
<% if (analyticsConfig.googleAnalytics.enabled || analyticsConfig.googleTagManager.enabled) { %>
<script src="/js/analytics.js"></script>
<% } %>

<!-- Web Vitals Monitoring -->
<script src="/js/web-vitals.js"></script>

<!-- Google Tag Manager (noscript) -->
<% if (analyticsConfig.googleTagManager.enabled && analyticsConfig.googleTagManager.containerId !== 'GTM-XXXXXXX') { %>
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=<%= analyticsConfig.googleTagManager.containerId %>"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
<% } %>

<!-- Hotjar Tracking Code -->
<% if (analyticsConfig.hotjar.enabled && analyticsConfig.hotjar.siteId !== 'YOUR_HOTJAR_ID') { %>
<script>
    (function(h,o,t,j,a,r){
        h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
        h._hjSettings={hjid:<%= analyticsConfig.hotjar.siteId %>,hjsv:6};
        a=o.getElementsByTagName('head')[0];
        r=o.createElement('script');r.async=1;
        r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
        a.appendChild(r);
    })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
</script>
<% } %>

<!-- Microsoft Clarity -->
<% if (analyticsConfig.microsoftClarity.enabled && analyticsConfig.microsoftClarity.projectId !== 'YOUR_CLARITY_ID') { %>
<script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "<%= analyticsConfig.microsoftClarity.projectId %>");
</script>
<% } %>

<!-- Cookie Consent (if needed for GDPR) -->
<script>
window.addEventListener('load', function() {
    // Simple cookie consent implementation
    if (!localStorage.getItem('cookieConsent')) {
        const banner = document.createElement('div');
        banner.innerHTML = `
            <div style="position: fixed; bottom: 0; left: 0; right: 0; background: #333; color: white; padding: 1rem; z-index: 10000; text-align: center;">
                <p style="margin: 0 0 1rem 0;">Questo sito utilizza cookie per migliorare l'esperienza utente. 
                <a href="/privacy" style="color: #ffc107;">Informativa Privacy</a></p>
                <button onclick="acceptCookies()" style="background: #0066cc; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                    Accetta
                </button>
                <button onclick="declineCookies()" style="background: transparent; color: white; border: 1px solid white; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; margin-left: 0.5rem;">
                    Rifiuta
                </button>
            </div>
        `;
        document.body.appendChild(banner);
    }
});

function acceptCookies() {
    localStorage.setItem('cookieConsent', 'accepted');
    document.querySelector('[style*="position: fixed"]').remove();
    // Enable analytics
    if (typeof gtag !== 'undefined') {
        gtag('consent', 'update', {
            'analytics_storage': 'granted'
        });
    }
}

function declineCookies() {
    localStorage.setItem('cookieConsent', 'declined');
    document.querySelector('[style*="position: fixed"]').remove();
}
</script>

<!-- WhatsApp Chat Widget (optional) -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Create WhatsApp floating button
    const whatsappBtn = document.createElement('a');
    whatsappBtn.href = 'https://wa.me/390398882041?text=Ciao%2C%20ho%20bisogno%20di%20assistenza%20IT';
    whatsappBtn.target = '_blank';
    whatsappBtn.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #25d366;
        color: white;
        border-radius: 50px;
        padding: 15px;
        text-decoration: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        transition: transform 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 500;
    `;
    whatsappBtn.innerHTML = `
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
        </svg>
        <span style="display: none;">WhatsApp</span>
    `;
    
    whatsappBtn.addEventListener('mouseenter', function() {
        this.style.transform = 'scale(1.1)';
        this.querySelector('span').style.display = 'inline';
    });
    
    whatsappBtn.addEventListener('mouseleave', function() {
        this.style.transform = 'scale(1)';
        this.querySelector('span').style.display = 'none';
    });
    
    document.body.appendChild(whatsappBtn);
});
</script>

<!-- Performance and Error Tracking -->
<script>
// Simple performance tracking
window.addEventListener('load', function() {
    if ('performance' in window) {
        const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
        console.log('Page load time:', loadTime + 'ms');
        
        // Send to analytics if available
        if (typeof gtag !== 'undefined') {
            gtag('event', 'timing_complete', {
                'name': 'load',
                'value': loadTime
            });
        }
    }
});

// Error tracking
window.addEventListener('error', function(e) {
    console.error('JavaScript error:', e.error);
    
    // Send to analytics if available
    if (typeof gtag !== 'undefined') {
        gtag('event', 'exception', {
            'description': e.error.toString(),
            'fatal': false
        });
    }
});
</script>
<% } %>

<% if (env === 'development') { %>
<!-- Development Scripts -->
<script>
console.log('ðŸ”§ Development mode active');
console.log('Environment:', '<%= env %>');
console.log('Current path:', '<%= currentPath %>');

// Development helpers
window.ITERA_DEV = {
    reload: () => fetch('/dev/reload').then(r => r.json()).then(console.log),
    info: () => fetch('/dev/info').then(r => r.json()).then(console.log),
    health: () => fetch('/health').then(r => r.json()).then(console.log)
};

console.log('Available dev commands: ITERA_DEV.reload(), ITERA_DEV.info(), ITERA_DEV.health()');
</script>
<% } %>
